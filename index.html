<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Zulu Live Translator</title>
    
    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#2563eb">
    <link rel="manifest" href="data:application/json;base64,ewogICJnameIjogIlp1bHUgTGl2ZSIsCiAgInNob3J0X25hbWUiOiAiWnVsdUxpdmUiLAogICJzdGFydF91cmwiOiAiLiIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgImJhY2tncm91bmRfY29sb3IiOiAiI2Y4ZmFmYmYiLAogICJ0aGVtZV9jb2xvciI6ICIjMjU2M2ViIiwKICAiaWNvbnMiOiBbCiAgICB7CiAgICAgICJzcmMiOiAiaHR0cHM6Ly9jZG4taWNvbnMtcG5nLmZsaXRpY29uLmNvbS81MTIvNDQxOC80NDE4NDcxLnBuZyIsCiAgICAgICJzaXplcyI6ICI1MTJ4NTEyIiwKICAgICAgInR5cGUiOiAiaW1hZ2UvcG5nIgogICAgfQogIF0KfQ==">

    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .pulse-speak { animation: speak-pulse 1.5s ease-in-out infinite; }
        @keyframes speak-pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.02); opacity: 0.9; }
            100% { transform: scale(1); opacity: 1; }
        }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="bg-slate-50 overflow-hidden">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const App = () => {
            const [apiKey, setApiKey] = useState(localStorage.getItem('gem_key') || '');
            const [showSettings, setShowSettings] = useState(!apiKey);
            const [isListening, setIsListening] = useState(false);
            const [isSpeaking, setIsSpeaking] = useState(false);
            const [transcript, setTranscript] = useState('');
            const [translation, setTranslation] = useState('');
            const [isProcessing, setIsProcessing] = useState(false);
            const [zuluToEnglish, setZuluToEnglish] = useState(true);
            const [error, setError] = useState(null);

            const recognitionRef = useRef(null);
            const debounceRef = useRef(null);
            const audioRef = useRef(null);
            const audioUnlocked = useRef(false);

            // Unlock audio on first interaction
            const unlockAudio = () => {
                if (audioUnlocked.current) return;
                const silentBuffer = new Audio("data:audio/wav;base64,UklGRigAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQQAAAAAAA==");
                silentBuffer.play().then(() => {
                    audioUnlocked.current = true;
                    console.log("Audio unlocked");
                }).catch(e => console.error("Audio unlock failed", e));
            };

            useEffect(() => {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (SpeechRecognition) {
                    recognitionRef.current = new SpeechRecognition();
                    recognitionRef.current.continuous = true;
                    recognitionRef.current.interimResults = true;
                    
                    recognitionRef.current.onresult = (event) => {
                        let currentText = '';
                        for (let i = event.resultIndex; i < event.results.length; i++) {
                            currentText += event.results[i][0].transcript;
                        }
                        setTranscript(currentText);
                        
                        if (debounceRef.current) clearTimeout(debounceRef.current);
                        debounceRef.current = setTimeout(() => {
                            if (currentText.trim().length > 1) handleTranslate(currentText);
                        }, 1500);
                    };

                    recognitionRef.current.onerror = (e) => {
                        if (e.error === 'not-allowed') setError("Microphone access denied.");
                    };
                }

                // Register simple Service Worker for PWA
                if ('serviceWorker' in navigator) {
                    const swCode = `self.addEventListener('fetch', function(event) {});`;
                    const blob = new Blob([swCode], {type: 'application/javascript'});
                    const swUrl = URL.createObjectURL(blob);
                    navigator.serviceWorker.register(swUrl);
                }
            }, [zuluToEnglish]);

            const handleTranslate = async (text) => {
                if (!apiKey || isProcessing) return;
                setIsProcessing(true);
                setError(null);

                try {
                    const prompt = `Translate exactly from ${zuluToEnglish ? 'Zulu' : 'English'} to ${zuluToEnglish ? 'English' : 'Zulu'}. ONLY return the translation text. Text: ${text}`;
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    const data = await res.json();
                    const result = data.candidates?.[0]?.content?.parts?.[0]?.text;

                    if (result) {
                        setTranslation(result);
                        playVoice(result);
                    }
                } catch (err) {
                    setError("Check API connection.");
                } finally {
                    setIsProcessing(false);
                }
            };

            const playVoice = async (text) => {
                if (!apiKey) return;
                try {
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: `Say clearly in ${zuluToEnglish ? 'English' : 'Zulu'}: ${text}` }] }],
                            generationConfig: { 
                                responseModalities: ["AUDIO"],
                                speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Kore" } } }
                            }
                        })
                    });
                    const data = await res.json();
                    const audioBase64 = data.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
                    
                    if (audioBase64) {
                        const binary = atob(audioBase64);
                        const array = new Uint8Array(binary.length);
                        for (let i = 0; i < binary.length; i++) array[i] = binary.charCodeAt(i);
                        const blob = new Blob([array], { type: 'audio/wav' });
                        const url = URL.createObjectURL(blob);
                        
                        if (audioRef.current) {
                            audioRef.current.src = url;
                            setIsSpeaking(true);
                            audioRef.current.play().catch(e => {
                                console.error("Playback failed", e);
                                setIsSpeaking(false);
                            });
                        }
                    }
                } catch (e) { console.error(e); }
            };

            const toggleMic = () => {
                unlockAudio();
                if (isListening) {
                    recognitionRef.current.stop();
                    setIsListening(false);
                } else {
                    setTranscript('');
                    setTranslation('');
                    recognitionRef.current.lang = zuluToEnglish ? 'zu-ZA' : 'en-US';
                    recognitionRef.current.start();
                    setIsListening(true);
                }
            };

            const saveKey = (val) => {
                setApiKey(val);
                localStorage.setItem('gem_key', val);
            };

            // Dynamic Font Size logic
            const getFontSize = (text, isBlue) => {
                const len = text.length;
                if (len < 20) return isBlue ? 'text-6xl' : 'text-5xl';
                if (len < 50) return isBlue ? 'text-4xl' : 'text-3xl';
                return isBlue ? 'text-2xl' : 'text-xl';
            };

            return (
                <div className="h-screen flex flex-col max-w-xl mx-auto bg-slate-50 relative overflow-hidden">
                    <audio ref={audioRef} onEnded={() => setIsSpeaking(false)} hidden />
                    
                    {showSettings && (
                        <div className="fixed inset-0 bg-slate-900/90 backdrop-blur-md z-50 flex items-center justify-center p-6">
                            <div className="bg-white rounded-[3rem] p-10 w-full shadow-2xl border border-slate-100">
                                <h2 className="text-3xl font-black mb-2 tracking-tighter">API Setup</h2>
                                <p className="text-slate-400 text-xs font-bold uppercase tracking-widest mb-6">Enter Gemini Credentials</p>
                                <input 
                                    type="password" 
                                    placeholder="Paste API Key"
                                    className="w-full p-5 bg-slate-50 rounded-2xl mb-6 outline-none border-2 border-transparent focus:border-blue-500 transition-all font-mono"
                                    value={apiKey}
                                    onChange={(e) => saveKey(e.target.value)}
                                />
                                <button 
                                    onClick={() => setShowSettings(false)}
                                    className="w-full py-5 bg-blue-600 text-white font-black rounded-2xl shadow-xl shadow-blue-100 active:scale-95 transition-all"
                                >
                                    OPEN TRANSLATOR
                                </button>
                            </div>
                        </div>
                    )}

                    <header className="p-6 flex justify-between items-center bg-white border-b border-slate-100 shadow-sm z-10">
                        <div className="flex items-center gap-3">
                            <div className="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center shadow-lg"><span className="text-white text-xl">üåê</span></div>
                            <div>
                                <h1 className="text-xl font-black tracking-tighter leading-none">ZULU <span className="text-blue-600">LIVE</span></h1>
                                <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest mt-1">Instant Conversation</p>
                            </div>
                        </div>
                        <button onClick={() => setShowSettings(true)} className="w-10 h-10 bg-slate-100 rounded-xl flex items-center justify-center text-lg hover:bg-blue-600 hover:text-white transition-all">‚öôÔ∏è</button>
                    </header>

                    <div className="flex-1 flex flex-col p-4 gap-4 overflow-hidden">
                        {/* Input Area */}
                        <div className="flex-1 bg-white rounded-[3rem] shadow-sm border border-slate-100 p-8 flex flex-col items-center justify-center relative min-h-0 overflow-hidden">
                            <span className="absolute top-8 left-10 text-[10px] font-bold text-slate-300 uppercase tracking-widest">
                                {zuluToEnglish ? 'Input: Zulu' : 'Input: English'}
                            </span>
                            <div className="overflow-y-auto hide-scrollbar text-center w-full px-2">
                                <p className={`font-bold leading-tight transition-all duration-300 ${getFontSize(transcript, false)} ${!transcript ? 'text-slate-100' : 'text-slate-800'}`}>
                                    {transcript || "Speak..."}
                                </p>
                            </div>
                            {isProcessing && <div className="mt-4 pulse text-blue-500 font-bold text-[10px] uppercase tracking-widest">Synchronizing...</div>}
                        </div>

                        {/* Controls Hub */}
                        <div className="flex justify-center items-center gap-6 -my-8 z-20">
                            <button 
                                onClick={() => { setZuluToEnglish(!zuluToEnglish); setTranscript(''); setTranslation(''); }}
                                className="w-14 h-14 bg-white shadow-xl rounded-2xl flex items-center justify-center text-xl hover:rotate-180 transition-all duration-500"
                                title="Swap Languages"
                            >
                                ‚áÑ
                            </button>
                            <button 
                                onClick={toggleMic}
                                className={`w-28 h-28 rounded-[2.5rem] shadow-2xl flex items-center justify-center text-5xl transition-all active:scale-90 ${isListening ? 'bg-red-500 ring-8 ring-red-50' : 'bg-blue-600 ring-8 ring-blue-50'}`}
                            >
                                {isListening ? 'üõë' : 'üé§'}
                            </button>
                            <button 
                                onClick={() => { setTranscript(''); setTranslation(''); setError(null); }}
                                className="w-14 h-14 bg-white shadow-xl rounded-2xl flex items-center justify-center text-xl active:scale-90 transition-all"
                            >
                                üóëÔ∏è
                            </button>
                        </div>

                        {/* Output Area */}
                        <div className={`flex-1 rounded-[3rem] shadow-2xl p-8 flex flex-col items-center justify-center relative min-h-0 overflow-hidden transition-all duration-500 ${isSpeaking ? 'bg-blue-500 pulse-speak' : 'bg-blue-600'}`}>
                            <span className="absolute top-8 left-10 text-[10px] font-bold text-blue-200 uppercase tracking-widest">
                                {zuluToEnglish ? 'Output: English' : 'Output: Zulu'}
                            </span>
                            <div className="overflow-y-auto hide-scrollbar text-center w-full px-2 text-white">
                                {error ? (
                                    <p className="text-xl font-bold opacity-80">{error}</p>
                                ) : (
                                    <p className={`font-black leading-tight transition-all duration-500 ${getFontSize(translation, true)} ${!translation ? 'text-blue-500' : 'text-white'}`}>
                                        {translation || "..."}
                                    </p>
                                )}
                            </div>
                            {translation && (
                                <button 
                                    onClick={() => playVoice(translation)} 
                                    className={`absolute bottom-8 right-10 w-14 h-14 rounded-full flex items-center justify-center transition-all ${isSpeaking ? 'bg-white text-blue-600' : 'bg-white/10 text-white'}`}
                                >
                                    {isSpeaking ? 'üîà' : 'üîä'}
                                </button>
                            )}
                        </div>
                    </div>

                    <footer className="p-6 text-center text-[8px] font-bold text-slate-300 uppercase tracking-[0.5em] z-10">
                        Neural Two-Way Pipeline ‚Ä¢ 2.5 Flash
                    </footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

