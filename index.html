<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zulu Live Translator</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
    </style>
</head>
<body class="bg-slate-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const App = () => {
            const [apiKey, setApiKey] = useState(localStorage.getItem('gem_key') || '');
            const [showSettings, setShowSettings] = useState(!apiKey);
            const [isListening, setIsListening] = useState(false);
            const [transcript, setTranscript] = useState('');
            const [translation, setTranslation] = useState('');
            const [isProcessing, setIsProcessing] = useState(false);
            const [zuluToEnglish, setZuluToEnglish] = useState(true);
            const [error, setError] = useState(null);

            const recognitionRef = useRef(null);
            const debounceRef = useRef(null);
            const audioRef = useRef(null);

            // Initialize Speech Recognition
            useEffect(() => {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (SpeechRecognition) {
                    recognitionRef.current = new SpeechRecognition();
                    recognitionRef.current.continuous = true;
                    recognitionRef.current.interimResults = true;
                    
                    recognitionRef.current.onresult = (event) => {
                        let currentText = '';
                        for (let i = event.resultIndex; i < event.results.length; i++) {
                            currentText += event.results[i][0].transcript;
                        }
                        setTranscript(currentText);
                        
                        if (debounceRef.current) clearTimeout(debounceRef.current);
                        debounceRef.current = setTimeout(() => {
                            if (currentText.trim().length > 1) handleTranslate(currentText);
                        }, 1400);
                    };

                    recognitionRef.current.onerror = (e) => {
                        if (e.error === 'not-allowed') setError("Mic access denied.");
                    };
                }
            }, [zuluToEnglish]);

            const handleTranslate = async (text) => {
                if (!apiKey) return;
                setIsProcessing(true);
                setError(null);

                try {
                    const prompt = `Translate to ${zuluToEnglish ? 'English' : 'Zulu'}. ONLY return the translation text. Text: ${text}`;
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    const data = await res.json();
                    const result = data.candidates?.[0]?.content?.parts?.[0]?.text;

                    if (result) {
                        setTranslation(result);
                        playVoice(result);
                    }
                } catch (err) {
                    setError("API Error. Check key.");
                } finally {
                    setIsProcessing(false);
                }
            };

            const playVoice = async (text) => {
                try {
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: `Say in ${zuluToEnglish ? 'English' : 'Zulu'}: ${text}` }] }],
                            generationConfig: { 
                                responseModalities: ["AUDIO"],
                                speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Kore" } } }
                            }
                        })
                    });
                    const data = await res.json();
                    const audioBase64 = data.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
                    
                    if (audioBase64) {
                        // Create a blob and play it
                        const byteCharacters = atob(audioBase64);
                        const byteNumbers = new Array(byteCharacters.length);
                        for (let i = 0; i < byteCharacters.length; i++) {
                            byteNumbers[i] = byteCharacters.charCodeAt(i);
                        }
                        const byteArray = new Uint8Array(byteNumbers);
                        const blob = new Blob([byteArray], { type: 'audio/wav' });
                        const url = URL.createObjectURL(blob);
                        
                        if (audioRef.current) {
                            audioRef.current.src = url;
                            audioRef.current.play().catch(e => console.error("Playback blocked", e));
                        }
                    }
                } catch (e) {
                    console.error("Voice Error", e);
                }
            };

            const toggleMic = () => {
                if (isListening) {
                    recognitionRef.current.stop();
                    setIsListening(false);
                } else {
                    setTranscript('');
                    setTranslation('');
                    recognitionRef.current.lang = zuluToEnglish ? 'zu-ZA' : 'en-US';
                    recognitionRef.current.start();
                    setIsListening(true);
                }
            };

            const saveKey = (val) => {
                setApiKey(val);
                localStorage.setItem('gem_key', val);
            };

            return (
                <div className="min-h-screen flex flex-col max-w-2xl mx-auto p-4 md:p-8">
                    <audio ref={audioRef} hidden />
                    
                    {showSettings && (
                        <div className="fixed inset-0 bg-slate-900/90 backdrop-blur-sm z-50 flex items-center justify-center p-6">
                            <div className="bg-white rounded-3xl p-8 w-full shadow-2xl">
                                <h2 className="text-2xl font-bold mb-4">API Setup</h2>
                                <input 
                                    type="password" 
                                    placeholder="Enter Gemini API Key"
                                    className="w-full p-4 bg-slate-100 rounded-xl mb-6 outline-none border-2 border-transparent focus:border-blue-500"
                                    value={apiKey}
                                    onChange={(e) => saveKey(e.target.value)}
                                />
                                <button 
                                    onClick={() => setShowSettings(false)}
                                    className="w-full py-4 bg-blue-600 text-white font-bold rounded-xl"
                                >
                                    Start Translator
                                </button>
                            </div>
                        </div>
                    )}

                    <header className="flex justify-between items-center mb-8">
                        <div>
                            <h1 className="text-2xl font-black tracking-tighter">ZULU <span className="text-blue-600">LIVE</span></h1>
                            <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Instant Conversation</p>
                        </div>
                        <button onClick={() => setShowSettings(true)} className="p-3 bg-white shadow-sm rounded-xl">‚öôÔ∏è</button>
                    </header>

                    <div className="flex-1 flex flex-col gap-4">
                        {/* Input Area */}
                        <div className="flex-1 bg-white rounded-[2.5rem] shadow-sm border border-slate-100 p-8 flex flex-col items-center justify-center relative min-h-[200px]">
                            <span className="absolute top-6 left-8 text-[10px] font-bold text-slate-300 uppercase tracking-widest">
                                {zuluToEnglish ? 'Zulu' : 'English'}
                            </span>
                            <p className={`text-4xl text-center font-bold ${!transcript ? 'text-slate-200' : 'text-slate-800'}`}>
                                {transcript || "Tap Mic to Talk"}
                            </p>
                            {isProcessing && <div className="mt-4 pulse text-blue-500 font-bold text-xs uppercase">Translating...</div>}
                        </div>

                        {/* Controls */}
                        <div className="flex justify-center items-center gap-6 -my-10 z-10">
                            <button 
                                onClick={() => { setZuluToEnglish(!zuluToEnglish); setTranscript(''); setTranslation(''); }}
                                className="w-14 h-14 bg-white shadow-xl rounded-2xl flex items-center justify-center text-xl"
                            >
                                ‚áÑ
                            </button>
                            <button 
                                onClick={toggleMic}
                                className={`w-24 h-24 rounded-[2rem] shadow-2xl flex items-center justify-center text-4xl transition-all ${isListening ? 'bg-red-500 scale-110' : 'bg-blue-600'}`}
                            >
                                {isListening ? 'üõë' : 'üé§'}
                            </button>
                            <button 
                                onClick={() => { setTranscript(''); setTranslation(''); }}
                                className="w-14 h-14 bg-white shadow-xl rounded-2xl flex items-center justify-center text-xl"
                            >
                                üóëÔ∏è
                            </button>
                        </div>

                        {/* Output Area */}
                        <div className="flex-1 bg-blue-600 rounded-[2.5rem] shadow-xl p-8 flex flex-col items-center justify-center relative min-h-[200px] text-white">
                            <span className="absolute top-6 left-8 text-[10px] font-bold text-blue-300 uppercase tracking-widest">
                                {zuluToEnglish ? 'English' : 'Zulu'}
                            </span>
                            <p className="text-5xl text-center font-black leading-tight">
                                {translation || "..."}
                            </p>
                            {translation && (
                                <button onClick={() => playVoice(translation)} className="absolute bottom-6 right-8 w-12 h-12 bg-white/10 rounded-full flex items-center justify-center">
                                    üîä
                                </button>
                            )}
                        </div>
                    </div>

                    <footer className="mt-12 text-center text-[10px] font-bold text-slate-300 uppercase tracking-[0.3em]">
                        Neural Two-Way Link
                    </footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

